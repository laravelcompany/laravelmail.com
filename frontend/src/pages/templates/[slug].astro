---
import DefaultLayout from '../../layouts/DefaultLayout.astro';
import db from '../../data/data.json';

// Get the slug from the URL params.
const { slug } = Astro.params;

// Find the matching template from the data.
const template = db.data.find(template => template.slug === slug);
const data = await fetch('http://0.0.0.0:11001/templates/' + template.slug).then((response) =>
  response.text()
);

// Instead of creating a Blob URL server-side, we'll handle the download client-side
---

<DefaultLayout title={'Free laravel mail template - ' + template.name}>
  <section class="my-32">
    <div class="container mx-auto">
      <h1 class="mb-8 text-5xl font-bold text-center">Free laravel mail template - {template.name}</h1>

      <div class="text-center">
        <img 
          src={'https://api.unlayer.com/v2/stock-templates/' + template.slug + '/thumbnail'} 
          alt={template.name} 
          class="object-cover mx-auto rounded-lg h-64" 
        />
      </div>

      <div class="mt-8 p-8 shadow-md rounded-lg">
        <p class="text-lg text-gray-600">
          <strong>Description:</strong> {template.description} 
        </p>
        <p class="text-lg text-gray-600">
          <strong>Rating:</strong> {template.rating}
        </p>
        <p class="text-lg text-gray-600">
          <strong>Type:</strong> {template.type}
        </p>
        <p class="text-lg text-gray-600">
          <strong>Votes:</strong> 
          2 stars: {template.votes['2'] || 0}, 
          3 stars: {template.votes['3'] || 0}, 
          4 stars: {template.votes['4'] || 0}, 
          5 stars: {template.votes['5'] || 0}
        </p>
      </div>

      <iframe srcdoc={data} style="width: 100vw; height:65vh;margin-top:20px;" class="shadow-md rounded-lg"></iframe>

      <div class="mt-10 text-2xl text-center">
        <button 
          id="downloadBtn"
          class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600"
          data-template={data}
          data-filename={template.slug + '.html'}
        >
          Download HTML Source Code
        </button>
      </div>
    </div>
  </section>
</DefaultLayout>

<script>
  // Handle download on the client side
  document.getElementById('downloadBtn')?.addEventListener('click', function(e) {
    const button = e.target as HTMLButtonElement;
    const templateData = button.dataset.template;
    const filename = button.dataset.filename;

    if (templateData && filename) {
      const blob = new Blob([templateData], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  });
</script>